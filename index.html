const towerGame = document.getElementById('towerGame');
const towerResetBtn = document.getElementById('tower-reset');
const towerWinSound = document.getElementById('tower-win');
const towerLoseSound = document.getElementById('tower-lose');

const rows = 12;
const cols = 4;

let currentLevel = 0; // Aloitetaan alimmaisesta kerroksesta (0)
let bombPositions = []; // Pommit kerroksittain
let selectedThisLevel = false;
let gameActive = true;

const levelMultipliers = Array.from({length: rows}, (_, i) => (1 + i * 0.3).toFixed(2));

function createBombs() {
  bombPositions = [];
  for(let i=0; i<rows; i++) {
    // Jokaiselle kerrokselle arvotaan yksi pommi sarakkeista 0-3
    bombPositions[i] = Math.floor(Math.random() * cols);
  }
}

function createTower() {
  towerGame.innerHTML = '';
  selectedThisLevel = false;
  for(let r = rows - 1; r >= 0; r--) { // Näytetään ylin kerros ylhäällä
    for(let c = 0; c < cols; c++) {
      const floor = document.createElement('div');
      floor.classList.add('floor');
      floor.dataset.level = r;
      floor.dataset.col = c;
      floor.textContent = `Lvl ${r+1}`;
      floor.title = `Kerroin: ${levelMultipliers[r]}x`;

      floor.addEventListener('click', () => selectFloor(floor, r, c));
      
      // Estetään klikkaus jos taso ei ole se missä ollaan
      if (r !== currentLevel || !gameActive) {
        floor.classList.add('disabled');
      }
      
      towerGame.appendChild(floor);
    }
  }
  updateBalanceDisplay();
}

function selectFloor(floor, level, col) {
  if(!gameActive) return;
  if(level !== currentLevel) return; // Vain aktiivinen kerros

  if(selectedThisLevel) return; // Vain yksi valinta per kerros

  if(col === bombPositions[level]) {
    // Pommi!
    floor.classList.add('bomb');
    towerLoseSound.volume = 0.3;
    towerLoseSound.play();

    alert(`Pommi! Hävisit pelin tasolla ${level + 1} -150 kolikkoa.`);
    updateBalance(-150);
    gameActive = false;
    disableAllFloors();
    return;
  } else {
    floor.classList.add('selected');
    towerWinSound.volume = 0.3;
    towerWinSound.play();

    const reward = Math.floor(levelMultipliers[level] * 100);
    alert(`Onnistuit tasolla ${level + 1}! Voitit ${reward} kolikkoa.`);
    updateBalance(reward);

    selectedThisLevel = true;
    disableFloorsOnLevel(level);

    // Siirrytään seuraavalle kerrokselle, jos mahdollista
    if(currentLevel < rows - 1) {
      currentLevel++;
      enableFloorsOnLevel(currentLevel);
    } else {
      alert("Onnittelut! Nousit viimeiselle tasolle!");
      gameActive = false;
      disableAllFloors();
    }
  }
}

function disableFloorsOnLevel(level) {
  const floors = towerGame.querySelectorAll(`.floor[data-level='${level}']`);
  floors.forEach(f => {
    if(!f.classList.contains('selected') && !f.classList.contains('bomb')) {
      f.classList.add('disabled');
    }
  });
}

function enableFloorsOnLevel(level) {
  const floors = towerGame.querySelectorAll(`.floor[data-level='${level}']`);
  floors.forEach(f => f.classList.remove('disabled'));
}

function disableAllFloors() {
  const floors = towerGame.querySelectorAll('.floor');
  floors.forEach(f => f.classList.add('disabled'));
}

function resetTower() {
  currentLevel = 0;
  gameActive = true;
  createBombs();
  createTower();
}

towerResetBtn.addEventListener('click', resetTower);

// Alusta peli
resetTower();
